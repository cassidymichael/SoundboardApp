<Window x:Class="Soundboard.Views.SoundsLibraryWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:Soundboard.ViewModels"
        Title="Sounds Library"
        Width="800" Height="550"
        MinWidth="600" MinHeight="400"
        WindowStartupLocation="CenterOwner"
        ShowInTaskbar="False"
        Background="{StaticResource SurfaceBackgroundBrush}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header: Search and Tags -->
        <Border Grid.Row="0"
                Background="{StaticResource ElevatedSurfaceBrush}"
                BorderBrush="{StaticResource BorderLightBrush}"
                BorderThickness="0,0,0,1"
                Padding="16,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="250"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Search Box -->
                <TextBox Grid.Column="0"
                         Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource SearchTextBoxStyle}"
                         Tag="Search sounds..."
                         Height="28"/>
            </Grid>
        </Border>

        <!-- Main Content: Sound List -->
        <Border Grid.Row="1" Padding="16">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Column Headers -->
                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="80"/>
                        <ColumnDefinition Width="80"/>
                        <ColumnDefinition Width="90"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="Name" FontWeight="SemiBold" Foreground="{StaticResource SecondaryTextBrush}"/>
                    <TextBlock Grid.Column="1" Text="Duration" FontWeight="SemiBold" Foreground="{StaticResource SecondaryTextBrush}"/>
                    <TextBlock Grid.Column="2" Text="Source" FontWeight="SemiBold" Foreground="{StaticResource SecondaryTextBrush}"/>
                    <TextBlock Grid.Column="3" Text="Actions" FontWeight="SemiBold" Foreground="{StaticResource SecondaryTextBrush}"/>
                </Grid>

                <!-- Sound List -->
                <ListBox Grid.Row="1"
                         ItemsSource="{Binding Sounds}"
                         SelectedItem="{Binding SelectedSound}"
                         Style="{StaticResource SoundListBoxStyle}"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         MouseDoubleClick="SoundItem_MouseDoubleClick">
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:SoundEntryViewModel}">
                            <Grid Height="32">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="90"/>
                                </Grid.ColumnDefinitions>

                                <!-- Name (with inline edit) -->
                                <Grid Grid.Column="0" VerticalAlignment="Center">
                                    <StackPanel Orientation="Horizontal"
                                                Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                        <Path Data="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A2.25,2.25 0 0,1 14.25,11A2.25,2.25 0 0,1 12,13.25A2.25,2.25 0 0,1 9.75,11A2.25,2.25 0 0,1 12,8.75Z"
                                              Fill="{StaticResource WarningBrush}"
                                              Width="14" Height="14"
                                              Stretch="Uniform"
                                              Margin="0,0,6,0"
                                              Visibility="{Binding IsMissing, Converter={StaticResource BoolToVisibilityConverter}}"
                                              ToolTip="File not found"/>
                                        <TextBlock Text="{Binding DisplayName}"
                                                   Foreground="{StaticResource PrimaryTextBrush}"
                                                   VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>
                                    <TextBox x:Name="EditTextBox"
                                             Text="{Binding DisplayName, UpdateSourceTrigger=PropertyChanged}"
                                             Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}"
                                             Height="24"
                                             Margin="0,0,8,0"
                                             KeyDown="EditTextBox_KeyDown"
                                             LostFocus="EditTextBox_LostFocus"/>
                                </Grid>

                                <!-- Duration -->
                                <TextBlock Grid.Column="1"
                                           Text="{Binding DurationDisplay}"
                                           Foreground="{StaticResource SecondaryTextBrush}"
                                           VerticalAlignment="Center"/>

                                <!-- Source -->
                                <TextBlock Grid.Column="2"
                                           Text="{Binding SourceDisplay}"
                                           Foreground="{StaticResource TertiaryTextBrush}"
                                           VerticalAlignment="Center"/>

                                <!-- Actions -->
                                <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Center">
                                    <Button Content="▶" ToolTip="Preview"
                                            Style="{StaticResource IconButtonStyle}"
                                            Command="{Binding DataContext.PlayPreviewForItemCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            IsEnabled="{Binding IsMissing, Converter={StaticResource InverseBoolConverter}}"/>
                                    <Button Content="■" ToolTip="Stop"
                                            Style="{StaticResource IconButtonStyle}"
                                            Command="{Binding DataContext.StopPreviewCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                    <Button Content="✕" ToolTip="Remove"
                                            Style="{StaticResource DangerIconButtonStyle}"
                                            Command="{Binding DataContext.RemoveSoundForItemCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"/>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <!-- Empty State -->
                <TextBlock Grid.Row="1"
                           Text="No sounds in library. Click 'Add Sound' to get started."
                           Foreground="{StaticResource SecondaryTextBrush}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Visibility="{Binding Sounds.Count, Converter={StaticResource ZeroToVisibilityConverter}}"/>
            </Grid>
        </Border>

        <!-- Footer: Actions -->
        <Border Grid.Row="2"
                Background="{StaticResource ElevatedSurfaceBrush}"
                BorderBrush="{StaticResource BorderLightBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left: Add Sound + Checkbox | Remove All -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="Add Sound"
                            Command="{Binding AddSoundCommand}"
                            MinWidth="100"/>

                    <CheckBox Content="Copy files to library"
                              IsChecked="{Binding CopyToLibrary}"
                              Foreground="{StaticResource SecondaryTextBrush}"
                              Margin="12,0,0,0"
                              VerticalAlignment="Center"
                              ToolTip="When checked, files are copied to the app folder. Otherwise, they're referenced from their original location."/>

                    <!-- Divider -->
                    <Border Width="1"
                            Background="{StaticResource BorderMediumBrush}"
                            Margin="16,2"/>

                    <Button Content="Remove All Sounds"
                            Command="{Binding RemoveAllSoundsCommand}"
                            Style="{StaticResource DangerButtonStyle}"/>
                </StackPanel>

                <!-- Right: View Library + Close -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="View Library Folder"
                            Command="{Binding OpenLibraryFolderCommand}"
                            Style="{StaticResource SecondaryButtonStyle}"/>

                    <Button Content="Close"
                            Click="CloseButton_Click"
                            Style="{StaticResource SecondaryButtonStyle}"
                            Margin="8,0,0,0"
                            MinWidth="70"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
